<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://unpkg.com/deck.gl@8.1.0/dist.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <style>
    #map {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    #layer-menu {
      position: absolute;
      background: #fff;
      padding: 10px;
    }

    #mvt-menu {
      position: absolute;
      left: 200px;
      background: #fff;
      padding: 10px;
    }

    #iso-menu {
      position: absolute;
      left: 400px;
      background: #fff;
      padding: 10px;
    }

    #hint {
      position: absolute;
      bottom: 30px;
      background: #fff;
      padding: 10px;
    }
  </style>
</head>

<body>
  <div id='map'></div>
  <div id='layer-menu'>
    <input id='vector' type='radio' name='layer-toggle' value='vector' checked='checked'><label
      for='vector'>vector</label>
    <input id='raster' type='radio' name='layer-toggle' value='raster'><label for='raster'>raster</label>
  </div>
  <div id='mvt-menu'>
    <input id='show-graph' type='checkbox'><label for='show-graph'>show GH graph</label>
  </div>
  <div id='iso-menu'>
    <input id='isochrone-radius' type='number' value=600><label for='isochrone-radius'> isochrone radius in
      seconds</label>
    <input id='use-deck' type='checkbox'><label for='use-deck'>use deck</label>
  </div>
  <div id='hint'>
    <p>Click map to calculate isochrone</p>
  </div>
  <script>
    var mapTilerKey = 'yrAYvi6TTYgg9U5mBtiY';
    var rasterStyle = {
      'version': 8,
      'sources': {
        'raster-tiles-source': {
          'type': 'raster',
          'tiles': [
            'https://a.tile.openstreetmap.de/{z}/{x}/{y}.png',
            'https://b.tile.openstreetmap.de/{z}/{x}/{y}.png',
            'https://c.tile.openstreetmap.de/{z}/{x}/{y}.png'
          ]
        }
      },
      'layers': [
        {
          'id': 'raster-tiles',
          'type': 'raster',
          'source': 'raster-tiles-source'
        }
      ]
    };
    var vectorStyle = 'https://api.maptiler.com/maps/basic/style.json?key=' + mapTilerKey;

    var map = new mapboxgl.Map({
      container: 'map',
      style: vectorStyle,
      center: [13.4110450, 52.5214697],
      zoom: 9
    });
    map.on('style.load', function addGHMvt() {
      // add GraphHopper vector tiles of road network. this is also called when we change the style
      map.addSource('gh-mvt', {
        type: 'vector',
        tiles: ['http://localhost:8989/mvt/{z}/{x}/{y}.mvt?details=road_class']
      });
      map.addLayer({
        'id': 'gh',
        'type': 'line',
        'source': 'gh-mvt',
        'source-layer': 'roads',
        'paint': {
          'line-color': [
            'match',
            ['get', 'road_class'],
            'motorway', 'red',
            'primary', 'orange',
            'trunk', 'orange',
            'secondary', 'yellow',
            /*other*/ 'grey'
          ]
        },
        'layout': {
          'visibility': 'none'
        }
      });
    });
    map.on('click', function (e) {
      // fetch GraphHopper isochrone and draw on map
      var counter = 0;
      var coordinates = [];
      var radius = document.getElementById('isochrone-radius').value;
      Papa.parse("http://localhost:8989/spt?profile=car&point=" + e.lngLat.lat + ", " + e.lngLat.lng + "&columns=prev_longitude,prev_latitude,longitude,latitude,distance,time&time_limit=" + radius, {
        download: true,
        worker: true,
        step: function (results) {
          var d = results.data;
          // skip the first line (column names) and the second (root node)
          if (counter > 1)
            coordinates.push([[parseFloat(d[0]), parseFloat(d[1])], [parseFloat(d[2]), parseFloat(d[3])]]);
          counter++;
        },
        complete: function () {
          if (map.getLayer('isochrone-layer')) {
            map.removeLayer('isochrone-layer');
          }
          if (map.getLayer('isochrone-deck-layer')) {
            map.removeLayer('isochrone-deck-layer');
          }
          var geojson = {
            'type': 'FeatureCollection',
            'features': [
              {
                'type': 'Feature',
                'geometry': {
                  'type': 'MultiLineString',
                  'coordinates': coordinates
                }
              }
            ]
          };
          var useDeck = document.getElementById('use-deck').checked;
          if (useDeck) {
            var deckLayer = new deck.MapboxLayer({
              'id': 'isochrone-deck-layer',
              'type': deck.LineLayer,
              'data': coordinates,
              getSourcePosition: d => d[0],
              getTargetPosition: d => d[1],
              getColor: d => [0, 0, 200]
            });
            map.addLayer(deckLayer);
          } else {
            var source = map.getSource('isochrone');
            if (!source) {
              map.addSource('isochrone', {
                'type': 'geojson',
                'data': geojson
              });
            } else {
              source.setData(geojson);
            }
            map.addLayer({
              'id': 'isochrone-layer',
              'type': 'line',
              'source': 'isochrone',
              'paint': {
                'line-color': 'red'
              }
            });
          }
        },
        error: function (e) {
          console.log('error when trying to show isochrone', e);
        }
      });
    });

    // setup layer menu
    var layerInputs = document.querySelectorAll('#layer-menu input');
    function changeLayer(layerId) {
      toggleMvt(false);
      document.querySelector('#show-graph').checked = false;
      if (layerId == 'vector') {
        map.setStyle(vectorStyle);
      } else if (layerId == 'raster') {
        map.setStyle(rasterStyle);
      }
    }
    for (var i = 0; i < layerInputs.length; i++) {
      layerInputs[i].onclick = e => changeLayer(e.target.id);
    }

    // setup mvt menu
    function toggleMvt(on) {
      if (on) {
        map.setLayoutProperty('gh', 'visibility', 'visible')
      } else {
        map.setLayoutProperty('gh', 'visibility', 'none')
      }
    }
    document.querySelector('#show-graph').onclick = e => toggleMvt(e.target.checked);
  </script>
</body>

</html>